{% extends "index.html" %}

{% block title %}
    <title>My Profile</title>
{% endblock %}

{% block style %}
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --light-bg: #ecf0f1;
            --dark-text: #2c3e50;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }
        .navbar {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .profile-card {
            max-width: 700px;
            margin: 50px auto;
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: var(--primary-color);
            color: #fff;
            border-radius: 12px 12px 0 0;
        }
        .form-label {
            font-weight: 600;
        }
    </style>
{% endblock %}

{% block main %}
<div class="container mt-5">
    <div class="card profile-card">
        <div class="card-header text-center py-4">
            <h4 class="mb-0">My Profile</h4>
        </div>
        <div class="card-body p-4">
            <form id="update-profile-form">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control form-control-lg" id="username" value="{{ user.username }}" required>
                </div>
                <div class="mb-4">
                    <label for="email" class="form-label">Email address</label>
                    <input type="email" class="form-control form-control-lg" id="email" value="{{ user.email }}" required>
                </div>
                <button type="submit" class="btn btn-primary btn-lg w-100">Update Profile</button>
            </form>

            <hr class="my-4">

            <div class="d-grid gap-2">
                <button class="btn btn-outline-secondary btn-lg" type="button" data-bs-toggle="collapse" data-bs-target="#changePasswordCollapse" aria-expanded="false" aria-controls="changePasswordCollapse">
                    Change Password
                </button>
            </div>
            <div class="collapse mt-3" id="changePasswordCollapse">
                <div class="card card-body">
                    <form id="change-password-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmNewPassword" name="confirm_new_password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Update Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% comment %} <footer class="bg-dark text-white-50 py-5 mt-5">
    <div class="container text-center">
        <p class="mb-0">&copy; 2025 Travel App. All Rights Reserved.</p>
    </div>
</footer> {% endcomment %}

<script>
    // JavaScript for profile update
    document.getElementById('update-profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');

        const username = usernameInput.value;
        const email = emailInput.value;

        try {
            const response = await fetch('/update-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('#update-profile-form input[name="csrfmiddlewaretoken"]').value
                },
                body: JSON.stringify({
                    username: username,
                    email: email
                })
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                if (data.username) {
                    usernameInput.value = data.username;
                }
                if (data.email) {
                    emailInput.value = data.email;
                }
                alert("Profile updated successfully! ✅");
            } else {
                let errorMsg = "Failed to update profile.";
                if (data.error) errorMsg = data.error;
                alert(`Error: ${errorMsg} ❌`);
            }
        } catch (err) {
            console.error('Fetch error:', err);
            alert("An error occurred. Please try again later.");
        }
    });

    // JavaScript for password update
    document.getElementById('change-password-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmNewPassword = confirmNewPasswordInput.value;

        if (newPassword !== confirmNewPassword) {
            alert("New passwords do not match. Please try again. ⚠️");
            return;
        }

        try {
            const response = await fetch('/update-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('#change-password-form input[name="csrfmiddlewaretoken"]').value
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    password: newPassword
                })
            });

            const data = await response.json();

            if (response.ok && data.status === 'success') {
                alert("Password updated successfully! You will need to log back in. ✅");
                // Clear the form fields on success
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
                // Redirect the user to the login page after a password change for security
            } else {
                let errorMsg = "Failed to update password.";
                if (data.error) errorMsg = data.error;
                alert(`Error: ${errorMsg} ❌`);
            }
        } catch (err) {
            console.error('Fetch error:', err);
            alert("An error occurred. Please try again later.");
        }
    });
</script>
{% endblock %}